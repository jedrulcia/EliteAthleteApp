@using TrainingPlanApp.Web.Models.Exercise
@using TrainingPlanApp.Web.Constants

@model ExerciseIndexVM

@{
	ViewData["Title"] = "Index";
	var errorMessage = TempData["ErrorMessage"] as string;
}

<div class="container">
	<div class="row justify-content-center">
		<div class="col-md-8">
			<ul class="nav nav-tabs" id="exerciseTabs" role="tablist">
				<li class="nav-item" role="presentation">
					<a class="nav-link active" id="my-exercises-tab" data-toggle="tab" href="#my-exercises" role="tab" aria-controls="my-exercises" aria-selected="true">My Exercises</a>
				</li>
				<li class="nav-item" role="presentation">
					<a class="nav-link" id="all-exercises-tab" data-toggle="tab" href="#all-exercises" role="tab" aria-controls="all-exercises" aria-selected="false">All Exercises</a>
				</li>
			</ul>
			<br><br />
			<div class="tab-content" id="exerciseTabsContent">
				<div class="tab-pane fade show active" id="my-exercises" role="tabpanel" aria-labelledby="my-exercises-tab">
					<h1>My Exercises <button data-coachId="@Model.CoachId" class="btn btn-primary btn-sm createBtn" type="button"><i class="fa-solid fa-plus">&nbsp;</i>Create New</button></h1>
					@if (!string.IsNullOrEmpty(errorMessage))
					{
						<div class="alert alert-danger">
							@errorMessage
						</div>
					}

					<table class="table">
						<thead>
							<tr>
								<th>
									@Html.DisplayNameFor(model => model.ExerciseVMs.First().Name)
								</th>
								<th>
									@Html.DisplayNameFor(model => model.ExerciseVMs.First().ExerciseCategory.Name)
								</th>
								<th>
									@Html.DisplayNameFor(model => model.ExerciseVMs.First().ExerciseMuscleGroup.Name)
								</th>
								<th></th>
							</tr>
						</thead>
						<tbody>
							@foreach (var item in Model.ExerciseVMs)
							{
								if (item.CoachId == Model.CoachId)
								{
									<tr>
										<td>
											@Html.DisplayFor(modelItem => item.Name)
										</td>
										<td>
											@Html.DisplayFor(modelItem => item.ExerciseCategory.Name)
										</td>
										<td>
											@Html.DisplayFor(modelItem => item.ExerciseMuscleGroup.Name)
										</td>
										<td class="text-end">
											<button data-exerciseid="@item.Id"
													data-exercisecategoryid="@item.ExerciseCategory.Id"
													data-exercisemusclegroupid="@item.ExerciseMuscleGroup.Id"
													data-coachid="@Model.CoachId"
													data-name="@item.Name"
													data-description="@item.Description"
													data-videolink="@item.VideoLink"
													data-setaspublic="@item.SetAsPublic"
													class="btn btn-primary btn-sm editBtn">
												<i class="fa-solid fa-pen-to-square">&nbsp;</i>Edit
											</button>

											<button data-name="@item.Name"
													data-videolink="@item.VideoLink"
													data-description="@item.Description"
													data-exercisecategoryname="@item.ExerciseCategory.Name"
													data-exercisemusclegroupname="@item.ExerciseMuscleGroup.Name"
													class="btn btn-secondary btn-sm detailsBtn">
												<i class="fa-solid fa-info-circle">&nbsp;</i>Details
											</button>

											<button data-exerciseid="@item.Id"
													class="btn btn-danger btn-sm deleteBtn">
												<i class="fa-solid fa-trash">&nbsp;</i>Delete
											</button>
										</td>
									</tr>
								}
							}
						</tbody>
					</table>
				</div>

				<div class="tab-pane fade" id="all-exercises" role="tabpanel" aria-labelledby="all-exercises-tab">
					<h1>All Exercises</h1>
					<table class="table" style="width:100%">
						<thead>
							<tr>
								<th>
									@Html.DisplayNameFor(model => model.ExerciseVMs.First().Name)
								</th>
								<th>
									@Html.DisplayNameFor(model => model.ExerciseVMs.First().ExerciseCategory.Name)
								</th>
								<th>
									@Html.DisplayNameFor(model => model.ExerciseVMs.First().ExerciseMuscleGroup.Name)
								</th>
								<th></th>
							</tr>
						</thead>
						<tbody>
							@foreach (var item in Model.ExerciseVMs)
							{
								if (item.CoachId == null)
								{
									<tr>
										<td>
											@Html.DisplayFor(modelItem => item.Name)
										</td>
										<td>
											@Html.DisplayFor(modelItem => item.ExerciseCategory.Name)
										</td>
										<td>
											@Html.DisplayFor(modelItem => item.ExerciseMuscleGroup.Name)
										</td>
										<td class="text-end">
											<button data-name="@item.Name"
													data-videolink="@item.VideoLink"
													data-description="@item.Description"
													data-exercisecategoryname="@item.ExerciseCategory.Name"
													data-exercisemusclegroupname="@item.ExerciseMuscleGroup.Name"
													class="btn btn-secondary btn-sm detailsBtn">
												<i class="fa-solid fa-info-circle">&nbsp;</i>Details
											</button>
										</td>
									</tr>
								}
							}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>


<!-- MODAL FOR EXERCISE CREATE -->
<div class="modal fade" id="createExerciseModal" tabindex="-1" role="dialog" aria-labelledby="createExerciseModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="createExerciseModalLabel">Create New Exercise</h5>
				<button type="button" class="close btn btn-dark" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="createForm" asp-action="Create" method="post">
					<input type="hidden" name="ExerciseCreateVM.CoachId" value="@Model.CoachId" />
					<div class="form-group">
						<label asp-for="ExerciseCreateVM.Name" class="control-label"></label>
						<input asp-for="ExerciseCreateVM.Name" class="form-control" />
						<span asp-validation-for="ExerciseCreateVM.Name" class="text-danger"></span>
					</div>
					<div class="form-group">
						<label asp-for="ExerciseCreateVM.VideoLink" class="control-label"></label>
						<input asp-for="ExerciseCreateVM.VideoLink" class="form-control" />
						<span asp-validation-for="ExerciseCreateVM.VideoLink" class="text-danger"></span>
					</div>
					<div class="form-group">
						<label asp-for="ExerciseCreateVM.Description" class="control-label"></label>
						<input asp-for="ExerciseCreateVM.Description" class="form-control" />
						<span asp-validation-for="ExerciseCreateVM.Description" class="text-danger"></span>
					</div>
					<div class="form-group">
						<label asp-for="ExerciseCreateVM.ExerciseCategoryId" class="control-label"></label>
						<select asp-for="ExerciseCreateVM.ExerciseCategoryId" asp-items="@Model.ExerciseCreateVM.AvailableCategories" class="form-select">
						</select>
						<span asp-validation-for="ExerciseCreateVM.ExerciseCategoryId" class="text-danger"></span>
					</div>
					<div class="form-group">
						<label asp-for="ExerciseCreateVM.ExerciseMuscleGroupId" class="control-label"></label>
						<select asp-for="ExerciseCreateVM.ExerciseMuscleGroupId" asp-items="@Model.ExerciseCreateVM.AvailableMuscleGroups" class="form-select">
						</select>
						<span asp-validation-for="ExerciseCreateVM.ExerciseMuscleGroupId" class="text-danger"></span>
					</div>
					<div class="form-group form-check">
						<input type="checkbox" asp-for="ExerciseCreateVM.SetAsPublic" class="form-check-input" id="setAsPublicCheckbox" />
						<label class="form-check-label" asp-for="ExerciseCreateVM.SetAsPublic">Set as public</label>
						<span asp-validation-for="ExerciseCreateVM.SetAsPublic" class="text-danger"></span>
					</div>
					<div class="form-group">
						<button type="submit" class="btn btn-primary" id="submitCreateForm">Create</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<!-- MODAL FOR EXERCISE EDIT -->
<div class="modal fade" id="editExerciseModal" tabindex="-1" role="dialog" aria-labelledby="editExerciseModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="editExerciseModalLabel">Edit Exercise</h5>
				<button type="button" class="close btn btn-dark" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="editForm" asp-action="Edit" method="post">
					<input type="hidden" id="exerciseId" name="ExerciseCreateVM.Id" />
					<input type="hidden" id="coachId" name="ExerciseCreateVM.CoachId" />
					<div class="form-group">
						<label asp-for="ExerciseCreateVM.Name" class="control-label"></label>
						<input id="name" class="form-control" name="ExerciseCreateVM.Name" />
						<span asp-validation-for="ExerciseCreateVM.Name" class="text-danger"></span>
					</div>
					<div class="form-group">
						<label asp-for="ExerciseCreateVM.VideoLink" class="control-label"></label>
						<input id="videoLink" class="form-control" name="ExerciseCreateVM.VideoLink" />
						<span asp-validation-for="ExerciseCreateVM.VideoLink" class="text-danger"></span>
					</div>
					<div class="form-group">
						<label asp-for="ExerciseCreateVM.Description" class="control-label"></label>
						<input id="description" class="form-control" name="ExerciseCreateVM.Description" />
						<span asp-validation-for="ExerciseCreateVM.Description" class="text-danger"></span>
					</div>
					<div class="form-group">
						<label asp-for="ExerciseCreateVM.ExerciseCategoryId" class="control-label"></label>
						<select id="exerciseCategoryId" name="ExerciseCreateVM.ExerciseCategoryId" class="form-select">
							@foreach (var category in Model.ExerciseCreateVM.AvailableCategories)
							{
								<option value="@category.Value">@category.Text</option>
							}
						</select>
						<span asp-validation-for="ExerciseCreateVM.ExerciseCategoryId" class="text-danger"></span>
					</div>
					<div class="form-group">
						<label asp-for="ExerciseCreateVM.ExerciseMuscleGroupId" class="control-label"></label>
						<select id="exerciseMuscleGroupId" name="ExerciseCreateVM.ExerciseMuscleGroupId" class="form-select">
							@foreach (var muscleGroup in Model.ExerciseCreateVM.AvailableMuscleGroups)
							{
								<option value="@muscleGroup.Value">@muscleGroup.Text</option>
							}
						</select>
						<span asp-validation-for="ExerciseCreateVM.ExerciseMuscleGroupId" class="text-danger"></span>
					</div>
					<div class="form-group form-check">
						<input type="checkbox" asp-for="ExerciseCreateVM.SetAsPublic" class="form-check-input" id="setAsPublicCheckbox" />
						<label class="form-check-label" asp-for="ExerciseCreateVM.SetAsPublic">Set as public</label>
						<span asp-validation-for="ExerciseCreateVM.SetAsPublic" class="text-danger"></span>
					</div>
					<div class="form-group">
						<button type="submit" class="btn btn-primary" id="submitEditForm">Save</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<!-- MODAL FOR EXERCISE DETAILS -->
<div class="modal fade" id="exerciseDetailsModal" tabindex="-1" role="dialog" aria-labelledby="exerciseDetailsModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="exerciseDetailsModalLabel">Exercise Details</h5>
				<button type="button" class="close btn btn-dark" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<h4 id="exerciseName"></h4>
				<div>
					<iframe id="exerciseVideoLink" width="100%" height="472" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
				</div>
				<h5 id="exerciseCategoryName"></h5>
				<h5 id="exerciseMuscleGroupName"></h5>
				<h4 id="exerciseDescription"></h4>
			</div>
		</div>
	</div>
</div>

<!-- MODAL FOR EXERCISE DELETE -->
<div class="modal fade" id="deleteExerciseModal" tabindex="-1" role="dialog" aria-labelledby="deleteExerciseModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="deleteExerciseModalLabel">Delete Exercise</h5>
				<button type="button" class="close btn btn-dark" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="deleteForm" asp-action="Delete">
					<input type="hidden" id="Id" name="Id" />
					<p>Are you sure you want to delete this exercise?</p>
					<h5 id="exerciseNameToDelete"></h5>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
			</div>
		</div>
	</div>
</div>

@section Scripts
{
	<script>
		$(function () {
			// DATATABLE INITIALIZE
			$('.table').DataTable();

			// SCRIPT TO HANDLE CLOSING MODALS
			$(document).on('click', '.close', function () {
				$(this).closest('.modal').modal('hide');
			});

			// SCRIPT TO HANDLE CREATING EXERCISE
			$(document).on('click', '.createBtn', function () {
				$('#createExerciseModal').modal('show');
			});

			// SCRIPT TO HANDLE EDITING EXERCISE
			$(document).on('click', '.editBtn', function () {
				var btn = $(this);
				var exerciseId = btn.data("exerciseid");
				var coachId = btn.data("coachid");
				var name = btn.data("name");
				var videoLink = btn.data("videolink");
				var description = btn.data("description");
				var exerciseCategoryId = btn.data("exercisecategoryid");
				var exerciseMuscleGroupId = btn.data("exercisemusclegroupid")
				var setAsPublic = btn.data("setaspublic");

				$('#exerciseId').val(exerciseId);
				$('#coachId').val(coachId);
				$('#name').val(name);
				$('#videoLink').val(videoLink);
				$('#description').val(description);
				$('#exerciseCategoryId').val(exerciseCategoryId);
				$('#exerciseMuscleGroupId').val(exerciseMuscleGroupId);
				$('#setAsPublic').val(setAsPublic);

				console.log("Opening edit modal");
				$('#editExerciseModal').modal('show');
			});

			// SCRIPT TO HANDLE EXERCISE DETAILS
			$(document).on('click', '.detailsBtn', function () {
				var btn = $(this);
				var name = btn.data("name");
				var exerciseVideoLink = btn.data("videolink");
				var exerciseDescription = btn.data("description");
				var exerciseCategoryName = btn.data("exercisecategoryname");
				var exerciseMuscleGroupName = btn.data("exercisemusclegroupname")

				$('#exerciseName').text(name);
				$('#exerciseDescription').text(exerciseDescription);
				$('#exerciseCategoryName').text(exerciseCategoryName);
				$('#exerciseMuscleGroupName').text(exerciseMuscleGroupName);
				var mainVideoId = exerciseVideoLink.split('v=')[1]?.split('&')[0];
				var mainEmbedUrl = "https://www.youtube.com/embed/" + mainVideoId;
				$('#exerciseVideoLink').attr('src', mainEmbedUrl);

				$('#exerciseDetailsModal').modal('show');
			});

			// SCRIPT TO HANDLE DELETING EXERCISE
			$(document).on('click', '.deleteBtn', function () {
				var btn = $(this);
				var exerciseId = btn.data("exerciseid");
				var exerciseName = btn.data("name");

				$('#Id').val(exerciseId);
				$('#exerciseNameToDelete').text(exerciseName);

				$('#deleteExerciseModal').modal('show');
			});

			// SCRIPT TO HANDLE DELETE CONFIRMATION
			$(document).on('click', '#confirmDeleteBtn', function () {
				$('#deleteForm').submit();
			});

			// Handle tab switch with Bootstrap Tabs
			$('#exerciseTabs a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
				e.target // newly activated tab
				e.relatedTarget // previous tab
			});

		});
	</script>
}
